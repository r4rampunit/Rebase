import pandas as pd
import sqlite3

def add_and_populate_column(self_location, t_location):
    try:
        # Connect to SQLite database
        conn = sqlite3.connect(self_location)
        cursor = conn.cursor()

        # Read Excel file
        df = pd.read_excel(t_location, sheet_name='Sheet1')
        
        # Convert dates to datetime
        df['Date'] = pd.to_datetime(df['Date'])

        # Add new column to database table
        try:
            cursor.execute("""
                ALTER TABLE Monthly_Table 
                ADD COLUMN HSS_deposit_Mtd_avg REAL
            """)
        except sqlite3.OperationalError:
            print("Column might already exist. Proceeding with update.")

        # Prepare update statement
        update_query = """
        UPDATE Monthly_Table 
        SET HSS_deposit_Mtd_avg = ? 
        WHERE Date = ?
        """

        # Perform updates
        for _, row in df.iterrows():
            cursor.execute(update_query, (row['HSS_deposit_Mtd_avg'], row['Date']))

        # Commit changes
        conn.commit()
        print(f"Successfully added and populated {len(df)} rows")

    except Exception as e:
        print(f"An error occurred: {e}")
        conn.rollback()

    finally:
        # Close the connection
        conn.close()

# Example usage
self_location = r'path/to/your/database.sqlite'
t_location = r'path/to/your/excel/file.xlsx'
add_and_populate_column(self_location, t_location)