import os
import sqlite3
import re

def create_database_layers(folder_path, db_path):
    # Connect to SQLite database (will create if not exists)
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()

    # Create Raw Layer
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS raw_layer_info (
            table_name TEXT PRIMARY KEY,
            year TEXT,
            quarter TEXT
        )
    ''')

    # Process files in the folder
    for filename in os.listdir(folder_path):
        # Check if filename matches the pattern BHCF20000331
        match = re.match(r'BHCF(\d{4})(\d{4})\.txt', filename)
        if match:
            year, quarter_code = match.groups()
            
            # Determine quarter based on quarter code
            quarter_map = {
                '0331': '1',
                '0630': '2', 
                '0930': '3',
                '1231': '4'
            }
            quarter = quarter_map.get(quarter_code, 'Unknown')
            
            # Create table name for raw layer
            table_name = f'BHCF_Year{year}_Quarter_{quarter}'
            
            # Read file contents
            with open(os.path.join(folder_path, filename), 'r') as file:
                content = file.read().strip()
                codes = content.split('^')
                
                # Remove empty strings
                codes = [code for code in codes if code]
            
            # Create table for this file
            cursor.execute(f'''
                CREATE TABLE IF NOT EXISTS "{table_name}" (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    code TEXT
                )
            ''')
            
            # Insert codes into table
            cursor.executemany(f'INSERT INTO "{table_name}" (code) VALUES (?)', 
                               [(code,) for code in codes])
            
            # Record table information in raw_layer_info
            cursor.execute('''
                INSERT OR REPLACE INTO raw_layer_info 
                (table_name, year, quarter) VALUES (?, ?, ?)
            ''', (table_name, year, quarter))

    # Create empty Mirror Layer tables
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS mirror_layer_info (
            table_name TEXT PRIMARY KEY,
            description TEXT
        )
    ''')

    # Create empty Transformed Layer tables
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS transformed_layer_info (
            table_name TEXT PRIMARY KEY,
            description TEXT
        )
    ''')

    # Commit changes and close connection
    conn.commit()
    conn.close()

    print("Database layers created successfully!")

# Example usage
folder_path = '/path/to/your/txt/files'
db_path = 'FRY9C_Database.sqlite'
create_database_layers(folder_path, db_path)
