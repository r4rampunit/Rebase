from openpyxl.formatting.rule import ColorScaleRule
import numpy as np
from openpyxl import load_workbook

def conditional_formatting_IFRS1Q(sheet):
    for row in sheet.iter_rows():
        for cell in row:
            if cell.value == '5yr Avg':
                # Define ranges for max, min, and average values
                max_value_range = sheet.iter_rows(min_row=cell.row + 18, max_row=cell.row + 21, min_col=cell.column + 1, max_col=cell.column + 4)
                min_value_range = sheet.iter_rows(min_row=cell.row + 18, max_row=cell.row + 21, min_col=cell.column + 1, max_col=cell.column + 4)
                avg_value_range = sheet.iter_rows(min_row=cell.row + 2, max_row=cell.row + 5, min_col=cell.column + 2, max_col=cell.column + 2)

                # Extract values from the ranges
                max_values = [c.value for r in max_value_range for c in r if isinstance(c.value, (int, float))]
                min_values = [c.value for r in min_value_range for c in r if isinstance(c.value, (int, float))]
                avg_values = [c.value for r in avg_value_range for c in r if isinstance(c.value, (int, float))]

                # Compute max, min, and average values
                max_value = max(max_values) if max_values else None
                min_value = min(min_values) if min_values else None
                avg_value = np.mean(avg_values) if avg_values else None

                # Skip if any value is not found
                if max_value is None or min_value is None or avg_value is None:
                    continue

                # Define the data range for conditional formatting
                data_range = f'{sheet.cell(row=cell.row + 12, column=cell.column + 1).coordinate}:{sheet.cell(row=cell.row + 11, column=cell.column + 4).coordinate}'

                # Define color scale rule
                min_color = 'FFCCCC'
                mid_color = 'FFFFFF'
                max_color = 'CCFFCC'

                rule = ColorScaleRule(start_type='min', start_value=min_value, start_color=min_color,
                                      mid_type='num', mid_value=avg_value, mid_color=mid_color,
                                      end_type='max', end_value=max_value, end_color=max_color)

                # Apply conditional formatting rule
                sheet.conditional_formatting.add(data_range, rule)

# Example usage
wb = load_workbook('your_workbook.xlsx')
sheet = wb['Sheet1']
conditional_formatting_IFRS1Q(sheet)
wb.save('your_workbook_with_formatting.xlsx')
















from openpyxl import load_workbook
from openpyxl.formatting.rule import ColorScaleRule
import numpy as np

def conditional_formatting_IFRS1Q(sheet):
    for row in sheet.iter_rows():
        for cell in row:
            if cell.value == '5yr Avg':
                max_value_range = sheet.iter_rows(min_row=cell.row + 18, max_row=cell.row + 21, min_col=cell.column + 1, max_col=cell.column + 4)
                min_value_range = sheet.iter_rows(min_row=cell.row + 18, max_row=cell.row + 21, min_col=cell.column + 1, max_col=cell.column + 4)
                avg_value_range = sheet.iter_rows(min_row=cell.row + 2, max_row=cell.row + 5, min_col=cell.column + 2, max_col=cell.column + 2)

                max_values = [c.value for r in max_value_range for c in r if isinstance(c.value, (int, float))]
                min_values = [c.value for r in min_value_range for c in r if isinstance(c.value, (int, float))]
                avg_values = [c.value for r in avg_value_range for c in r if isinstance(c.value, (int, float))]

                max_value = max(max_values) if max_values else None
                min_value = min(min_values) if min_values else None
                avg_value = np.mean(avg_values) if avg_values else None

                if max_value is None or min_value is None or avg_value is None:
                    print(f"Skipping cell at {cell.coordinate} due to missing value.")
                    continue

                data_range = f'{sheet.cell(row=cell.row + 12, column=cell.column + 1).coordinate}:{sheet.cell(row=cell.row + 15, column=cell.column + 4).coordinate}'

                min_color = 'FFCCCC'
                mid_color = 'FFFFFF'
                max_color = 'CCFFCC'

                rule = ColorScaleRule(start_type='num', start_value=min_value, start_color=min_color,
                                      mid_type='num', mid_value=avg_value, mid_color=mid_color,
                                      end_type='num', end_value=max_value, end_color=max_color)

                sheet.conditional_formatting.add(data_range, rule)
                print(f"Applied conditional formatting to range: {data_range}")

# Use context manager to ensure the file is properly closed after processing
file_path = 'your_workbook.xlsx'
output_file_path = 'your_workbook_with_formatting.xlsx'

with load_workbook(file_path) as wb:
    sheet = wb['Sheet1']
    conditional_formatting_IFRS1Q(sheet)
    wb.save(output_file_path)

print(f"Workbook saved successfully to {output_file_path}")










df = pd.DataFrame(data)
iso_dict = {}
for index, row in df.iterrows():
    iso_code = row['ISOCODES']
    check = row['Checks']

    if iso_code not in iso_dict:
        iso_dict[iso_code] = []

    iso_dict[iso_code].append(check)

for iso_code in iso_dict:
    iso_dict[iso_code] = tuple(iso_dict[iso_code])