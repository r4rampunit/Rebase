<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MI Tool Visualization</title>
</head>
<body>
    <div class="logo-container"></div>
    <h1>MI Tool Visualization</h1>
    <div class="dashboard-container">
        <div class="dropdown-container left">
            <select name="folder" id="folder">
                <option value="">Select Folder</option>
                {% for folder in folders %}
                    <option value="{{ folder }}" {% if folder == selected_folder %} selected{% endif %}>{{ folder }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="dropdown-container right">
            <select name="subfolder" id="subfolder">
                <option value="">Select Subfolder</option>
                {% for subfolder in subfolders %}
                    <option value="{{ subfolder }}" {% if subfolder == selected_subfolder %}selected{% endif %}>{{ subfolder }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
    {% if selected_folder and selected_subfolder %}
        <h2>Selected Folder: {{ selected_folder }} / {{ selected_subfolder }}</h2>
    {% endif %}
    <script>
        document.getElementById('folder').addEventListener('change', function() {
            window.location.href = '?folder=' + this.value;
        });
        document.getElementById('subfolder').addEventListener('change', function() {
            const folder = document.getElementById('folder').value;
            const subfolder = this.value;
            if (folder && subfolder) {
                window.location.href = "{% url 'mi_chart' %}?folder=" + encodeURIComponent(folder) + "&subfolder=" + encodeURIComponent(subfolder);
            }
        });
    </script>
</body>
</html>



import pandas as pd
from openpyxl.styles import Font
from datetime import datetime
<<<<<<< HEAD
=======

def formatting_red_IFRS4Q(sheet):
    workbook_path = r".\Input\Mapping_File Copy.xlsx"
    data_edge = pd.read_excel(workbook_path, sheet_name="Data_Edge")
    red_font_color = 'FFFF0000'

    # Pre-process data_edge
    data_edge['ISOCODES'] = data_edge['ISOCODES'].astype(str)
    data_edge['Description'] = data_edge['Description'].astype(str)
    data_edge['Prev_Data_Edge'] = pd.to_datetime(data_edge['Prev_Data_Edge'])

    # Create a dictionary for faster lookup
    data_edge_dict = {(row['ISOCODES'], row['Description']): row['Prev_Data_Edge'] for _, row in data_edge.iterrows()}

    # Get all cell values at once
    all_cells = list(sheet.iter_rows(values_only=True))

    # Find the user_inputs[1] cells
    target_cells = [(row_idx, col_idx) for row_idx, row in enumerate(all_cells, 1) 
                    for col_idx, cell_value in enumerate(row, 1) if cell_value == user_inputs[1]]

    # Process date column once
    date_column = [cell[0] for cell in all_cells[3:24]]
    datetime_index = pd.to_datetime([date for date in date_column if date and date != ''], 
                                    format="%m/%d/%Y", errors='coerce')
    formatted_dates = [date.strftime('%Y-%m-%d') if pd.notnull(date) else None for date in datetime_index]

    for row, col in target_cells:
        isocodes = sheet.cell(row=row, column=col+8).value
        checks = sheet.cell(row=row-1, column=col+7).value

        prev_data_edge = data_edge_dict.get((str(isocodes), str(checks)))
        if prev_data_edge is None:
            continue

        prev_data_edge_str = prev_data_edge.strftime('%Y-%m-%d')
        if prev_data_edge_str not in formatted_dates:
            continue

        row_matched_with_date = formatted_dates.index(prev_data_edge_str) + 4

        range_to_change_font_color = sheet[
            sheet.cell(row=row+3, column=col).coordinate:
            sheet.cell(row=row_matched_with_date, column=col+5).coordinate
        ]

        new_font = Font(color=red_font_color, italic=True, name='Univers Next for HSBC Light')
        for row in range_to_change_font_color:
            for cell in row:
                cell.font = new_font



from datetime import datetime, timedelta, date
>>>>>>> origin/master

def formatting_red_IFRS4Q(sheet):
    workbook_path = r".\Input\Mapping_File Copy.xlsx"
    data_edge = pd.read_excel(workbook_path, sheet_name="Data_Edge")
    red_font_color = 'FFFF0000'

    # Pre-process the date column
    date_column = [cell.value for cell in sheet['A4:A24'] if cell.value and cell.value != '']
    datetime_index = pd.to_datetime(date_column, format="%m/%d/%Y", errors='coerce')
    formatted_dates = datetime_index.strftime('%Y-%m-%d').tolist()

    # Create a dictionary for faster lookup
    data_edge_dict = data_edge.set_index(['ISOCODES', 'Description']).to_dict('index')

    for row in sheet.iter_rows():
        for cell in row:
            if cell.value == user_inputs[1]:
                isocodes = sheet.cell(row=cell.row, column=cell.column + 8).value
                checks = sheet.cell(row=cell.row - 1, column=cell.column + 7).value

                match_data_edge = data_edge_dict.get((isocodes, checks))
                if match_data_edge:
                    prev_data_edge = pd.to_datetime(match_data_edge['Prev_Data_Edge'])
                    prev_data_edge_str = prev_data_edge.strftime('%m/%d/%Y')

                    row_matched_with_date = next((idx for idx, date in enumerate(date_column, start=4)
                                                  if date == prev_data_edge_str), None)

                    if row_matched_with_date:
                        font = Font(color=red_font_color, italic=True, name='Univers Next for HSBC Light')
                        for row in range(cell.row + 3, row_matched_with_date + 1):
                            for col in range(cell.column, cell.column + 6):
                                sheet.cell(row=row, column=col).font = font

    return sheet






def dashboard(request):
    folders = get_folders()
    selected_folder = request.GET.get("folder", None)
    selected_subfolder = request.GET.get("subfolder", None)
    subfolders = get_subfolders(selected_folder) if selected_folder else []

    context = {
        "folders": folders,
        "subfolders": subfolders,
        "selected_folder": selected_folder,
        "selected_subfolder": selected_subfolder,
    }

    return render(request, 'mi_templates/dashboard.html', context)

def mi_chart(request):
    selected_folder = request.GET.get("folder", None)
    selected_subfolder = request.GET.get("subfolder", None)

    if not (selected_folder and selected_subfolder):
        return redirect('dashboard')

    dataframes = read_excel_files(selected_folder, selected_subfolder)

    # Process dataframes and create lists
    lic_df = pd.concat([dataframes.get('lic_hbap_first_run', pd.DataFrame()),
                        dataframes.get('lic_hbap_last_run', pd.DataFrame())])

    context = {
        "Organisational_unit_level_1_list": lic_df["Organisational_unit_level_1"].unique().tolist(),
        "Organisational_unit_level_2_list": lic_df["Organisational_unit_level_2"].unique().tolist(),
        "Organisational_unit_level_3_list": lic_df["Organisational_unit_level_3"].unique().tolist(),
        "Country_of_Exposure_list": lic_df["Country_of_Exposure"].unique().tolist(),
        "Asset_class_list": lic_df["Asset_class"].unique().tolist(),
        "Product_Type_list": lic_df["Product_Type"].unique().tolist(),
        "Basel_Approach_list": lic_df["Basel_Approach"].unique().tolist(),
        "ST_scenario_combo": [f"{st} {scenario}" for st in lic_df["ST"].unique() for scenario in lic_df["scenario"].unique()],
    }

    return render(request, 'mi_templates/mi_chart.html', context)




from django.urls import path
from . import views

urlpatterns = [
    path('', views.dashboard, name='dashboard'),
    path('mi_chart/', views.mi_chart, name='mi_chart'),
]


document.getElementById('subfolder').addEventListener('change', function() {
    const folder = document.getElementById('folder').value;
    window.location.href = '/mi_chart/?folder=' + folder + '&subfolder=' + this.value;
});




<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MI Tool Visualization</title>
</head>
<body>
    <div class="logo-container"></div>
    <h1>MI Tool Visualization</h1>
    <div class="dashboard-container">
        <div class="dropdown-container left">
            <select name="folder" id="folder">
                <option value="">Select Folder</option>
                {% for folder in folders %}
                    <option value="{{ folder }}" {% if folder == selected_folder %}selected{% endif %}>{{ folder }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="dropdown-container right">
            <select name="subfolder" id="subfolder">
                <option value="">Select Subfolder</option>
                {% for subfolder in subfolders %}
                    <option value="{{ subfolder }}" {% if subfolder == selected_subfolder %}selected{% endif %}>{{ subfolder }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    {% if selected_folder and selected_subfolder %}
        <h2>Selected Folder: {{ selected_folder }} / {{ selected_subfolder }}</h2>
    {% endif %}

    <script>
        document.getElementById('folder').addEventListener('change', function() {
            window.location.href = '?folder=' + this.value;
        });

        document.getElementById('subfolder').addEventListener('change', function() {
            const folder = document.getElementById('folder').value;
            window.location.href = '?folder=' + folder + '&subfolder=' + this.value;
        });
    </script>
</body>
</html>




<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MI Chart</title>
</head>
<body>
    <h1>MI Chart</h1>
    <div class="dropdowns-container">
        <div class="dropdowns-wrapper">
            <div class="dropdown-wrapper">
                <label for="Organisational_unit_level_1">Organisational Unit Level 1</label>
                <select class="multiselect" name="Organisational_unit_level_1" id="Organisational_unit_level_1" multiple>
                    {% for option in Organisational_unit_level_1_list %}
                        <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="dropdown-wrapper">
                <label for="Organisational_unit_level_2">Organisational Unit Level 2</label>
                <select class="multiselect" name="Organisational_unit_level_2" id="Organisational_unit_level_2" multiple>
                    {% for option in Organisational_unit_level_2_list %}
                        <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="dropdown-wrapper">
                <label for="Organisational_unit_level_3">Organisational Unit Level 3</label>
                <select class="multiselect" name="Organisational_unit_level_3" id="Organisational_unit_level_3" multiple>
                    {% for option in Organisational_unit_level_3_list %}
                        <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="dropdown-wrapper">
                <label for="Country_of_Exposure">Country of Exposure</label>
                <select class="multiselect" name="Country_of_Exposure" id="Country_of_Exposure" multiple>
                    {% for option in Country_of_Exposure_list %}
                        <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="dropdown-wrapper">
                <label for="Asset_class">Asset Class</label>
                <select class="multiselect" name="Asset_class" id="Asset_class" multiple>
                    {% for option in Asset_class_list %}
                        <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="dropdown-wrapper">
                <label for="Product_Type">Product Type</label>
                <select class="multiselect" name="Product_Type" id="Product_Type" multiple>
                    {% for option in Product_Type_list %}
                        <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="dropdown-wrapper">
                <label for="Basel_Approach">Basel Approach</label>
                <select class="multiselect" name="Basel_Approach" id="Basel_Approach" multiple>
                    {% for option in Basel_Approach_list %}
                        <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="dropdown-wrapper">
                <label for="ST_scenario_combo">ST Scenario Combo</label>
                <select class="multiselect" name="ST_scenario_combo" id="ST_scenario_combo" multiple>
                    {% for option in ST_scenario_combo %}
                        <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <script>
        // You might want to add some JavaScript here to handle the multiselect functionality
    </script>
</body>
</html>



from django.shortcuts import render
from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
import json

@csrf_exempt
def dashboard(request):
    # Your existing code to prepare the lists and dataframe
    Organisational_unit_level_1_list = [...]
    Organisational_unit_level_2_list = [...]
    Organisational_unit_level_3_list = [...]
    Country_of_Exposure_list = [...]
    Asset_class_list = [...]
    Product_Type_list = [...]
    Basel_Approach_list = [...]
    ST_scenario_combo = [...]

    # Get the dataframe (assuming you have a function or method to do this)
    df = get_your_dataframe()

    if request.method == 'POST':
        # Handle the AJAX request
        selections = json.loads(request.body)

        # Print selections for the first three dropdowns
        print("Dropdown1 selection:", selections.get('Dropdown1', []))
        print("Dropdown2 selection:", selections.get('Dropdown2', []))
        print("Dropdown3 selection:", selections.get('Dropdown3', []))

        # Store the selections in the session
        request.session['dropdown_selections'] = selections

        # Filter the dataframe based on selections
        for dropdown, values in selections.items():
            if values:
                df = df[df[dropdown].isin(values)]

        # Return a success response
        return JsonResponse({'status': 'success'})

    # For GET requests, retrieve selections from session
    selections = request.session.get('dropdown_selections', {})

    # If there are selections, filter the dataframe
    if selections:
        for dropdown, values in selections.items():
            if values:
                df = df[df[dropdown].isin(values)]

    # Prepare your context
    context = {
        'Organisational_unit_level_1_list': Organisational_unit_level_1_list,
        'Organisational_unit_level_2_list': Organisational_unit_level_2_list,
        'Organisational_unit_level_3_list': Organisational_unit_level_3_list,
        'Country_of_Exposure_list': Country_of_Exposure_list,
        'Asset_class_list': Asset_class_list,
        'Product_Type_list': Product_Type_list,
        'Basel_Approach_list': Basel_Approach_list,
        'ST_scenario_combo': ST_scenario_combo,
        'filtered_data': df.to_dict('records'),  # or however you pass your dataframe to the template
        'current_selections': selections  # Pass the current selections to the template
    }

    return render(request, 'your_template.html', context)







<script>
$(document).ready(function() {
    $(".multiselect").select2({
        placeholder: "Select one or more options",
        closeOnSelect: false,
        allowClear: true,
        tags: true
    });

    // Set initial selections
    var currentSelections = {{ current_selections|safe }};
    for (var dropdown in currentSelections) {
        $(".multiselect[name='" + dropdown + "']").val(currentSelections[dropdown]).trigger('change');
    }

    function updateSelectedItems() {
        var allSelected = true;
        var selectedItems = {};
        $('.multiselect').each(function() {
            var dropdownName = $(this).attr('name');
            var selected = $(this).select2('data');
            if (selected.length === 0) {
                allSelected = false;
            }
            selectedItems[dropdownName] = selected.map(item => item.text);
        });

        if (allSelected) {
            var html = '<h3>Selected Items:</h3>';
            for (var dropdown in selectedItems) {
                html += '<p><strong>' + dropdown + ':</strong> ' + selectedItems[dropdown].join(', ') + '</p>';
            }
            $('#selectedItems').html(html).show();

            // Send selected items to the server
            $.ajax({
                url: '{% url "dashboard" %}',  // Assuming 'dashboard' is the name of your URL pattern
                type: 'POST',
                data: JSON.stringify(selectedItems),
                contentType: 'application/json',
                success: function(response) {
                    console.log('Selections updated successfully');
                    location.reload();  // Reload the page to apply the filter
                },
                error: function(error) {
                    console.error('Error updating selections:', error);
                }
            });
        } else {
            $('#selectedItems').hide();
        }
    }

    $('.multiselect').on('change', updateSelectedItems);
});
</script>



<script>
$(document).ready(function() {
    $(".multiselect").select2({
        placeholder: 'Select one or more than one options',
        closeOnSelect: false,
        allowClear: true,
        tags: true
    });

    function updateSelectedItems() {
        var allSelected = true;
        var selectedItems = {};
        $('.multiselect').each(function() {
            var dropdownName = $(this).attr('name');
            var selected = $(this).select2('data');
            if (selected.length == 0) {
                allSelected = false;
            }
            selectedItems[dropdownName] = selected.map(item => item.text);
        });

        if (allSelected) {
            var html = '<h3>Selected Items:</h3>';
            for (var dropdown in selectedItems) {
                html += '<p><strong>' + dropdown + ':</strong> ' + selectedItems[dropdown].join(', ') + '</p>';
            }
            $('#selectedItems').html(html).show();

            // Send data to server
            $.ajax({
                url: '/update_selected_items/',  // You'll need to define this URL
                type: 'POST',
                data: JSON.stringify(selectedItems),
                contentType: 'application/json',
                success: function(response) {
                    console.log('Server response:', response);
                }
            });
        } else {
            $('#selectedItems').hide();
        }
    }

    $('.multiselect').on('change', updateSelectedItems);
});
</script>



from django.http import JsonResponse
from django.views.decorators.csrf import csrf_exempt
import json

@csrf_exempt
def update_selected_items(request):
    if request.method == 'POST':
        data = json.loads(request.body)
        print("Received data:", data)  # This will print the data for testing
        # You can process the data here as needed
        return JsonResponse({'status': 'success'})

def mi_chart(request):
    folders = get_folders()
    selected_folder = request.GET.get("folder", None)
    selected_subfolder = request.GET.get("subfolder", None)
    subfolders = get_subfolders(selected_folder) if selected_folder else []

    if selected_folder and selected_subfolder:
        dataframes = read_excel_files(selected_folder, selected_subfolder)

    context = {
        'folders': folders,
        'subfolders': subfolders,
        'dataframes': dataframes,
    }
    return render(request, 'mi_templates/mi_chart.html', context)




from django.urls import path
from . import views

urlpatterns = [
    path('mi_chart/', views.mi_chart, name='mi_chart'),
    path('update_selected_items/', views.update_selected_items, name='update_selected_items'),
]





from django.http import JsonResponse, HttpResponseBadRequest
from django.views.decorators.csrf import csrf_exempt
from django.shortcuts import render
import json

@csrf_exempt
def mi_chart(request):
    if request.method == 'POST':
        try:
            # Handle AJAX request
            data = json.loads(request.body)
            print("Received data:", data)  # This will print the data for testing
            # You can process the data here as needed
            return JsonResponse({'status': 'success'})
        except json.JSONDecodeError:
            return HttpResponseBadRequest('Invalid JSON data')

    elif request.method == 'GET':
        # Handle GET request (initial page load)
        folders = get_folders()
        selected_folder = request.GET.get("folder", None)
        selected_subfolder = request.GET.get("subfolder", None)
        subfolders = get_subfolders(selected_folder) if selected_folder else []

        dataframes = []
        if selected_folder and selected_subfolder:
            dataframes = read_excel_files(selected_folder, selected_subfolder)

        context = {
            'folders': folders,
            'subfolders': subfolders,
            'dataframes': dataframes,
        }
        return render(request, 'mi_templates/mi_chart.html', context)

    else:
        # Handle other HTTP methods
        return HttpResponseBadRequest('Invalid request method')




